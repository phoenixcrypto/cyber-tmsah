// Prisma Schema for Cyber TMSAH
// PostgreSQL Database with full type safety

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table for authentication
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  @unique
  name      String
  password  String   // bcrypt hashed
  role      UserRole @default(viewer)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([email])
  @@map("users")
}

enum UserRole {
  admin
  editor
  viewer
}

// Schedule items for class schedules
model ScheduleItem {
  id           String      @id @default(cuid())
  title        String
  time         String
  location     String
  instructor   String
  type         ScheduleType
  group        ScheduleGroup
  sectionNumber Int?
  day          ScheduleDay
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([group])
  @@index([sectionNumber])
  @@index([day])
  @@map("schedule_items")
}

enum ScheduleType {
  lecture
  lab
}

enum ScheduleGroup {
  Group1
  Group2
}

enum ScheduleDay {
  Saturday
  Sunday
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
}

// Materials/Subjects
model Material {
  id            String   @id @default(cuid())
  title         String
  titleEn       String
  description   String   @db.Text
  descriptionEn String   @db.Text
  icon          String   // lucide-react icon name
  color         String   // Tailwind color class
  articlesCount Int      @default(0)
  lastUpdated   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  articles      Article[]

  @@index([title])
  @@map("materials")
}

// Articles within materials
model Article {
  id          String        @id @default(cuid())
  materialId  String
  title       String
  titleEn     String
  content     String        @db.Text // HTML content
  contentEn   String        @db.Text // HTML content in English
  excerpt     String?       @db.Text
  excerptEn   String?       @db.Text
  author      String
  status      ArticleStatus @default(draft)
  publishedAt DateTime?
  views       Int           @default(0)
  tags        String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  material    Material      @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([status])
  @@index([publishedAt])
  @@map("articles")
}

enum ArticleStatus {
  published
  draft
}

// Downloadable software
model DownloadSoftware {
  id            String   @id @default(cuid())
  name          String
  nameEn        String
  description   String   @db.Text
  descriptionEn String   @db.Text
  icon          String   // lucide-react icon name
  videoUrl      String?
  downloadUrl   String?
  category      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
  @@map("download_software")
}

// News articles
model NewsArticle {
  id            String        @id @default(cuid())
  title         String
  titleEn       String
  subjectId     String
  subjectTitle  String
  subjectTitleEn String
  url           String
  status        ArticleStatus @default(draft)
  publishedAt   DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
  @@index([publishedAt])
  @@map("news_articles")
}

// Static pages (About, Contact, Terms, Privacy, etc.)
model Page {
  id                String     @id @default(cuid())
  slug              String     @unique
  title             String
  titleEn           String
  content           String      @db.Text // HTML content
  contentEn         String      @db.Text // HTML content in English
  metaDescription   String?     @db.Text
  metaDescriptionEn String?     @db.Text
  status            PageStatus  @default(draft)
  order             Int?        @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([slug])
  @@index([status])
  @@map("pages")
}

enum PageStatus {
  published
  draft
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

// Note: PasswordResetToken.userId references User.id but relation is optional
// to avoid circular dependencies. Handle manually in code.

// API request logs for monitoring
model ApiLog {
  id          String   @id @default(cuid())
  method      String
  path        String
  statusCode  Int
  responseTime Int      // milliseconds
  ipAddress   String?
  userAgent   String?   @db.Text
  userId      String?
  error       String?   @db.Text
  createdAt   DateTime  @default(now())

  @@index([path])
  @@index([statusCode])
  @@index([createdAt])
  @@map("api_logs")
}

